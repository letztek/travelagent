# Track Specification: US-604 AI 韌性與日誌系統整合

## 1. 概述 (Overview)
本 Track 旨在提升 TravelAgent 系統在面對 AI 服務不穩定時的韌性，並建立一套完整的日誌追蹤系統。這包含自動重試機制、使用者手動重試介面，以及針對 AI 互動內容的審計日誌 (Audit Logs)，以支援未來在雲端環境下的監控與優化。

## 2. 功能需求 (Functional Requirements)

### 2.1 AI 自動重試與錯誤處理 (US-604)
- **自動重試機制**：針對 AI API 回傳之暫時性錯誤（如 503 Overloaded, 429 Too Many Requests），系統應在背景自動重試最多 2 次（總共 3 次嘗試）。
- **指數退避 (Exponential Backoff)**：兩次重試之間需有延遲時間，且延遲時間隨次數增加。
- **手動重試介面**：若背景重試 2 次皆失敗，UI 應顯示錯誤提示與「重試」按鈕，讓使用者手動觸發。
- **手動重新調整**：在行程產出或缺口分析後，提供「重新產生」或「調整」按鈕，允許使用者在 AI 回應內容不佳時主動要求重製。

### 2.2 混合式日誌系統 (Logging System)
- **系統日誌 (System Logs)**：一般的運行訊息（INFO, WARN, ERROR）輸出至控制台，以便在雲端平台（如 Vercel）的監控介面查看。
- **AI 審計日誌 (AI Audit Logs)**：專門記錄與 AI 的每一次對話，儲存於 Supabase 資料庫。
    - **記錄內容**：Prompt 內容、AI 回應原文、模型名稱、處理時長、錯誤代碼 (如有)、使用者 ID。
    - **目的**：用於分析 AI 表現、優化 Prompt 以及追蹤 Token 成本。

## 3. 非功能需求 (Non-Functional Requirements)
- **資料庫效能**：日誌寫入動作應非阻塞 (Non-blocking)，不應影響主業務流程的響應速度。
- **安全性**：日誌記錄需遮蔽機敏資訊（如 API Key）。
- **雲端相容性**：確保在 Serverless 環境下運行良好。

## 4. 驗收標準 (Acceptance Criteria)
- [ ] 模擬 503 錯誤時，系統會自動在背景嘗試 3 次才報錯。
- [ ] 當 AI 最終失敗時，頁面上會出現顯眼的重試按鈕。
- [ ] 頁面上存在可主動點擊的「重新產生」功能。
- [ ] 每次 AI 呼叫完成後，Supabase 的 `ai_audit_logs` 表中會有一筆正確紀錄。
- [ ] 雲端環境能正確捕獲控制台輸出的 Error 等級日誌。

## 5. 超出範圍 (Out of Scope)
- 視覺化的日誌管理後台介面（僅先完成資料庫儲存）。
- 前端客戶端行為追蹤（如點擊流分析）。
